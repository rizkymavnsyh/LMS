!function(o){var i={__onSelect:null,__multiple:!1,__context:null,activeFrame:!1,frame:function(e){e=o.extend({},e||{});var t=100*Math.random();return this._frame||(this._frame=[]),this._frame[t]||(this._frame[t]=wp.media({title:e.title||"Select Media",button:{text:e.button_text||"Insert"},multiple:e.multiple}),this._frame[t].state("library").on("select",this.select)),this._frame[t]},select:function(){if("function"==typeof i.__onSelect){let e=this.get("selection");e=(i.__multiple?e:e.single()).toJSON(),i.__onSelect.call(i._frame,e,i.__context),i.__onSelect=null,i.__context=null}},open:function(e){if("function"==typeof(e=o.extend({multiple:!1,context:null,onSelect:function(){}},e||{})).onSelect){i.__onSelect=e.onSelect,i.__multiple=e.multiple,i.__context=e.context;const t=i.frame(e);t.open()}}};o(document).ready(function(){var d={now:Date.now||function(){return(new Date).getTime()},debounce:function(t,i,a){let n,s,r,o,c;var l=function(){var e=d.now()-o;e<i&&0<=e?n=setTimeout(l,i-e):(n=null,a||(c=t.apply(r,s),n||(r=s=null)))};return function(){r=this,s=arguments,o=d.now();var e=a&&!n;return n=n||setTimeout(l,i),e&&(c=t.apply(r,s),r=s=null),c}}};function n(e,t){o.ajax({url:"",data:{"lp-ajax":"update-course-certificate",course_id:e,cert_id:t},success:function(){o("#certificate-browser").find(".theme.updating").removeClass("updating")}})}if(o(document).on("click",".button-assign-certificate",function(e){e.preventDefault();const t=o("#certificate-browser").find(".themes"),i=t.find(".theme"),a=o(this).closest(".theme");i.removeClass("active"),t.prepend(a.addClass("active updating")),n(o("#post_ID").val(),a.data("id"))}).on("click",".button-remove-certificate",function(e){e.preventDefault(),e.stopPropagation(),o(this).closest(".theme").removeClass("active").addClass("updating"),n(o("#post_ID").val(),0)}),"undefined"==typeof lpCertificatesSettings)return console.log("lpCertificatesSettings is not defined!"),void console.log("Only load when edit certificate");window.$LP_Certificates=new Vue({el:"#learn-press-certificates",template:"#tmpl-certificates",data:o.extend({dragover:!1,viewport:{width:0,height:0,templateWidth:0,templateHeight:0,ratio:1},$view:!1,$layerOptions:null,loaded:!1,i18n:{},template:"xxx"},lpCertificatesSettings),computed:{getMaxWidth:function(){return Math.random()}},created:function(){var e=this;setTimeout(function(){e.init()},300)},methods:{init:function(){var a=this;this.$img=this.$(".cert-template"),this.$img_preload=document.getElementById("cert-template-preload"),this.initCanvas(),this.initDragAndDrop(),o("#cert-template-preload").length&&(this.viewport={width:this.$img_preload.width,height:this.$img_preload.height,templateWidth:this.$img_preload.naturalWidth,templateHeight:this.$img_preload.naturalHeight,ratio:this.$img_preload.width/this.$img_preload.naturalWidth},this.updateView()),this.$img.on("load",function(){a.viewport={width:this.width,height:this.height,templateWidth:this.naturalWidth,templateHeight:this.naturalHeight,ratio:this.width/this.naturalWidth},console.log(a.viewport),a.loaded&&a.ajaxUpdateTemplate(),a.updateView()}).trigger("load"),this.$layerOptions=o(".cert-layer-options"),o(document).on("certificate/change-layer-option",d.debounce(function(e,t){const i={};i[t.name]=t.value,a.updateActiveLayer(i)},100)),o(window).on("resize.certificate-update-view",function(){let e=o(this).data("timer");e&&clearTimeout(e),e=setTimeout(function(){a.updateView()},300)}),o(document).on("click",".layer-center",function(){switch(o(this).data("center")){case"center-h":a.centerH();break;case"center-v":a.centerV();break;case"center":a.center()}}),o(document).on("click",".cert-layers .layer",function(e){var t=a.findLayer(o(this).data("layer"));t&&a.$canvas.setActiveObject(t),o(e.target).is("a")&&(a.deleteLayer(),e.preventDefault())}),this.loaded=!0},findLayer:function(e){var t=this.$canvas.getObjects();for(const i in t)if(t[i].name===e)return t[i];return!1},addCustomPreview:function(){},centerV:function(e){if(e=e||this.getActiveLayer()){const t={top:(this.$canvas.height/this.viewport.ratio-e.height*Math.abs(e.scaleY))/2};"center"===e.originY&&(t.top+=e.height/2),e.set(t),e.setCoords(),this.updateView(),this.updateActiveLayer(t)}},centerH:function(e){if(e=e||this.getActiveLayer()){const t={left:(this.$canvas.width/this.viewport.ratio-e.width*Math.abs(e.scaleX))/2};"center"===e.originX&&(t.left+=e.width/2),e.set(t),e.setCoords(),this.updateView(),this.updateActiveLayer(t)}},center:function(e){this.centerV(e),this.centerH(e)},deleteLayer:function(){if(confirm(this.i18n.confirm_remove_layer)){const e=this.getActiveLayer(),t=e.get("name");e&&(this.$canvas.remove(e),Vue.http.post("",{layer:t},{emulateJSON:!0,params:{"lp-ajax":"cert-remove-layer",id:this.id}}).then(function(){o(".cert-layers").children().filter('[data-layer="'+t+'"]').remove()}))}},getActiveLayer:function(){return this.$canvas.getActiveObject()},getMaxWidth:function(){return this.$().width()-60},updateActiveLayer:function(e,t){if(t=t||this.getActiveLayer()){for(const i in e)this.setLayerProp(t,i,e[i]);this.$canvas.renderAll(),this.ajaxUpdateLayer(t)}},calculate:function(){this.viewport=o.extend(this.viewport,{width:this.$img.width(),height:this.$img.height(),ratio:this.$img.width()/this.viewport.templateWidth})},updateView:function(){var e=this.getMaxWidth();this.calculate(),this.viewport.templateWidth<e&&this.template?this.$("#cert-design-view").css("width",this.viewport.width+60).addClass("small"):this.$("#cert-design-view").css("width","").removeClass("small"),this.$canvas.setHeight(this.viewport.height),this.$canvas.setWidth(this.viewport.width),this.$canvas.setZoom(this.viewport.ratio),this.$canvas.calcOffset(),this.$canvas.renderAll()},$:function(e){const t=o(this.$el);return e?t.find(e):t},getLayerOptions:function(e){return e?e.toObject(this.getExtendedFields()):{}},getExtendedFields:function(){let e=["name","fieldType","display","customText","format","variable","formatDate","qr_size","fontFile"],t=o(document).triggerHandler("learn_press_certificates_extended_fields",[e]);return void 0===t&&(t=e),t},showControls:function(e){},showLines:function(){var e=this.getActiveLayer();e?(this.$("#cert-design-view").addClass("dragover"),this.$("#cert-design-line-horizontal").css("top",e.top*this.viewport.ratio),this.$("#cert-design-line-vertical").css("left",e.left*this.viewport.ratio-1)):this.hideLines()},hideLines:function(){this.$("#cert-design-view").removeClass("dragover")},toFixedX:function(e){return Math.ceil(10*e)/10},hideControls:function(){},getLayers:function(){const e={},t=this.$canvas.getObjects();for(const i in t)e[t[i].name]=this.getLayerOptions(t[i]);return e},ajaxUpdateLayers:d.debounce(function(){return Vue.http.post("",{layers:this.getLayers()},{emulateJSON:!0,params:{"lp-ajax":"cert-update-layers",id:this.id}})},300),ajaxUpdateLayer:d.debounce(function(e,t){e=o.isPlainObject(e)?e:this.getLayerOptions(e);var i=this;if(JSON.stringify(e).md5()!==e.hash)return Vue.http.post("",{layer:e,"load-settings":t?"yes":"no"},{emulateJSON:!0,params:{"lp-ajax":"cert-update-layer",id:this.id}}).then(function(e){const t=o(e.body);t.hasClass("cert-layer-options")&&(i.$layerOptions=t,o("#certificates-options").removeClass("loading").find(".inside").html(i.$layerOptions))})},300),ajaxUpdateTemplate:d.debounce(function(){return Vue.http.post("",{template:this.template},{emulateJSON:!0,params:{"lp-ajax":"cert-update-template",id:this.id}})},300),ajaxLoadLayer:d.debounce(function(e){var t=this;return o("#certificates-options").show().addClass("loading"),Vue.http.post("",{layer:e.get("name")},{emulateJSON:!0,params:{"lp-ajax":"cert-load-layer",id:this.id}}).then(function(e){t.$layerOptions=o(e.body),o("#certificates-options").removeClass("loading").find(".inside").html(t.$layerOptions)})},300),addLayerList:function(e){e=o('<div class="layer" data-layer="'+e.name+'">Layer #'+e.text+'<a href=""></a></div>');o(".cert-layers").prepend(e)},addLayer:function(e,t){return t=o.extend({setActive:!0},t||{}),o.isPlainObject(e)&&(e=this.createLayer(e)),e&&(this.loaded&&this.ajaxUpdateLayer(e,!0),this.$canvas.add(e),this.addLayerList(e),t.setActive&&this.$canvas.setActiveObject(e),this.$canvas.renderAll()),e},createLayer:function(e){try{var t=o.extend({fontSize:24,left:0,top:0,lineHeight:1,originX:"center",originY:"center",fontFamily:"Helvetica",name:this.uniqueId(),fieldType:"custom",variable:""},e),i=e.text||"",a=new fabric.Text(i,t),n=this;"verified-link"==e.fieldType&&(t.qr_size=40);i=/^(https?|s?ftp):\/\//i.test(e.text);if("verified-link"==e.fieldType&&0<e.qr_size&&i){const s=new Image;t.type="image",t.height=t.qr_size,t.width=t.qr_size,s.crossOrigin="Anonymous",s.src=e.text,a=new fabric.Image(s,t)}a.set({borderColor:"#AAA",cornerColor:"#666",cornerSize:7,transparentCorners:!0,padding:0}),o.each(t,function(e,t){n.setLayerProp(a,e,t)});t=o(document).triggerHandler("learn_press_certificate_layer_obj",[a,e]);"object"==typeof t&&(a=t)}catch(e){console.log(e)}return a},updateLayerOptions:d.debounce(function(e){const i=this,t=this.getLayerOptions(e||this.getActiveLayer()),a=this.$layerOptions.find(":input");o.each(t,function(e,t){switch(e){case"fontFamily":break;case"fontStyle":case"fontWeight":"normal"===t&&(t="");break;case"originY":"middle"===t&&(t="center");break;case"top":case"left":t=parseInt(t);break;case"angle":case"scaleX":case"scaleY":t=i.toFixedX(t)}a.filter('[name="'+e+'"]').val(t)}),o("#certificates-options").show()},300),setLayerProp:function(i,e,t){const a={};switch(void 0===t&&(t=""),e){case"color":a.fill=t;break;case"scaleX":case"scaleY":isNaN(t)&&(t=0),t<0?"scaleX"===e?i.flipX=!0:i.flipY=!0:"scaleX"===e?i.flipX=!1:i.flipY=!1,a[e]=this.toFixedX(Math.abs(t));break;case"top":case"left":isNaN(t)&&(t=0),a[e]=parseInt(t);break;case"angle":a[e]=this.toFixedX(t);break;case"fontFamily":t=""+t,i.set("fontFamily",t.replace(/\+/," "));break;default:a[e]=t}a.flipX&&(a.scaleX=-this.toFixedX(a.scaleX)),a.flipY&&(a.scaleY=-this.toFixedX(a.scaleY)),o.each(a,function(e,t){i.set(e,t)}),i.setCoords()},onObjectSelected:function(e){var t=this.getLayerOptions(e.target);for(const i in t)this.setLayerProp(e.target,i,t[i]);o(".cert-layers").children().removeClass("active").filter('[data-layer="'+e.target.name+'"]').addClass("active"),this.ajaxLoadLayer(e.target)},onObjectMoving:function(e){this.updateLayerOptions(),this.ajaxUpdateLayer(e.target),this.showLines()},onObjectRotating:function(e){this.updateLayerOptions(),this.ajaxUpdateLayer(e.target);e=this.$canvas.getActiveObject(),e=this.toFixedX(e.angle);this.setPropSlider("angle",e),this.hideLines()},onObjectMouseup:function(){this.hideLines()},onObjectMousedown:function(){this.showLines()},onBeforeSelectionCleared:function(e){o("#certificates-options").hide(),o(".cert-layers").children().removeClass("active"),this.hideLines()},onObjectModified:function(e){this.showControls(e)},limitObjectScale:function(){let e=this.$canvas.getActiveObject(),t=this.toFixedX(e.scaleX),i=this.toFixedX(e.scaleY);e.flipX&&(t=-t),e.flipY&&(i=-i),this.ajaxUpdateLayer(e),this.setPropSlider("scaleX",t),this.setPropSlider("scaleY",i)},setPropSlider:function(e,t){this.$layerOptions.find('input[name="'+e+'"]').val(t).siblings(".cert-option-slider").slider("option","value",t)},initCanvas:function(){if(!this.$canvas){const i=this,e=this.$("canvas");this.$canvas=new fabric.Canvas(e.get(0),this.layers),this.$canvas.on({"object:selected":this.onObjectSelected,"object:moving":this.onObjectMoving,"object:rotating":this.onObjectRotating,"mouse:up":this.onObjectMouseup,"mouse:down":this.onObjectMousedown,"before:selection:cleared":this.onBeforeSelectionCleared,"object:modified":this.onObjectModified}).observe("object:scaling",this.limitObjectScale),this.$canvas.selection=!1,o.each(this.layers,function(e,t){t.type&&i.addLayer(t,{setActive:!1})}),d.debounce(this.updateView,300)(),console.log("initCanvas")}},initDragAndDrop:function(){var r=this;this.$view=o(this.$el).find("#cert-design-view"),o(".cert-fields li").draggable({helper:"clone",drag:function(e,t){var i=r.$view.offset();r.dragover={left:t.offset.left-i.left+26,top:t.offset.top-i.top+13},r.dragover.left<0||r.dragover.top<0?r.dragover=!1:r.updateLines()}}),o("#cert-design-editor").droppable({over:function(e,t){r.dragover=!0,r.dragover=t.position,r.updateLines()},out:function(){r.dragover=!1},drop:function(e,t){r.dragover=!1;var i=r.$view.find(".canvas-container").offset(),a=(t.offset.left-i.left+t.draggable.outerWidth()/2)/r.viewport.ratio,i=(t.offset.top-i.top+t.draggable.outerHeight()/2)/r.viewport.ratio;r.addLayerByDrop({top:i,left:a,text:t.draggable.text().trim(),fieldType:t.draggable.data("type")})}}),o(".cert-layers").sortable({axis:"y",start:function(e,t){const i=o(this).children();t.item.data("position",i.index(t.item))},update:function(e,n){const s=r.$canvas.getActiveObject();if(s){let e=o(this).children(),t=n.item.data("position"),i=e.index(n.item),a=0;if(i>t)for(a=0;a<i-t;a++)s.sendBackwards();else for(a=0;a<t-i;a++)s.bringForward();r.ajaxUpdateLayers()}}})},updateRulers:function(){this.dragover},updateLines:function(){this.dragover&&o(this.$el).find(".cert-design-line").filter(".horizontal").css("top",this.dragover.top).end().filter(".vertical").css("left",this.dragover.left)},uniqueId:function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+e()+e()},selectTemplate:function(){i.open({context:this,onSelect:function(e,t){e.sizes?t.template=e.sizes.full.url:t.template=e.url,t.updateView()}})},setPreview:function(){alert(0)},addLayerByDrop:function(e){e=this.createLayer(e);return e&&(this.addLayer(e),this.$canvas.calcOffset(),this.$canvas.renderAll()),e}}})})}(jQuery);
